<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escaner de Texto con C√°mara</title>
    <!-- Importar Tesseract.js desde CDN -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@v5/dist/tesseract.min.js'></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f5f5f5; }
        #cameraView { width: 100%; max-width: 640px; background: #000; border-radius: 8px; margin: 15px auto; }
        button { padding: 14px 28px; margin: 10px; font-size: 16px; border: none; border-radius: 6px; cursor: pointer; background-color: #007bff; color: white; transition: background 0.3s; }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #cccccc; cursor: not-allowed; }
        #resultado { margin-top: 25px; padding: 20px; border: 2px dashed #28a745; border-radius: 8px; background: white; text-align: left; white-space: pre-wrap; min-height: 100px; }
        .status { margin: 10px; color: #666; font-style: italic; }
    </style>
</head>
<body>
    <h1>üì∑ Esc√°ner de Texto OCR (Espa√±ol)</h1>
    <p>Activa la c√°mara, enfoca un texto y capt√∫ralo. El texto se extraer√° directamente en tu navegador.</p>

    <!-- Contenedor para la vista de la c√°mara -->
    <video id="cameraView" playsinline autoplay></video>
    <br>

    <!-- Botones de control -->
    <button id="btnActivar">Activar C√°mara</button>
    <button id="btnCapturar" disabled>Capturar y Leer Texto</button>
    <button id="btnParar" disabled>Parar C√°mara</button>
    <button id="btnCambiarCamara" disabled>Cambiar C√°mara</button>

    <!-- Mensajes de estado del OCR -->
    <div id="statusOCR" class="status"></div>

    <!-- Donde se mostrar√° el texto extra√≠do -->
    <h3>Texto Reconocido:</h3>
    <div id="resultado">Aqu√≠ aparecer√° el texto extra√≠do...</div>

    <script>
        // Elementos del DOM
        const video = document.getElementById('cameraView');
        const btnActivar = document.getElementById('btnActivar');
        const btnCapturar = document.getElementById('btnCapturar');
        const btnParar = document.getElementById('btnParar');
        const btnCambiarCamara = document.getElementById('btnCambiarCamara');
        const resultadoDiv = document.getElementById('resultado');
        const statusDiv = document.getElementById('statusOCR');

        let stream = null;
        let currentFacingMode = 'environment'; // C√°mara trasera por defecto

        // 1. Funci√≥n para activar la c√°mara
        async function activarCamara(facingMode) {
            try {
                // Detener el stream anterior si existe
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                }
                // Solicitar acceso a la c√°mara
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: facingMode, width: { ideal: 1280 }, height: { ideal: 720 } },
                    audio: false
                });
                video.srcObject = stream;
                btnActivar.disabled = true;
                btnCapturar.disabled = false;
                btnParar.disabled = false;
                btnCambiarCamara.disabled = false;
                resultadoDiv.textContent = 'C√°mara activada. Enfoca el texto y haz clic en "Capturar y Leer Texto".';
                statusDiv.textContent = '';
            } catch (err) {
                resultadoDiv.textContent = 'Error al acceder a la c√°mara: ' + err.message;
                console.error(err);
            }
        }

        // 2. Activar c√°mara trasera al inicio
        btnActivar.addEventListener('click', () => activarCamara(currentFacingMode));

        // 3. Alternar entre c√°mara frontal y trasera
        btnCambiarCamara.addEventListener('click', () => {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            activarCamara(currentFacingMode);
            resultadoDiv.textContent = `Cambiando a c√°mara ${currentFacingMode === 'environment' ? 'trasera' : 'frontal'}...`;
        });

        // 4. Capturar foto y realizar OCR
        btnCapturar.addEventListener('click', async () => {
            if (!stream) return;

            // Crear un canvas para capturar el fotograma del video
            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Mostrar mensaje de progreso
            statusDiv.textContent = 'üîÑ Procesando imagen con OCR (esto puede tardar unos segundos)...';
            statusDiv.style.color = '#007bff';
            resultadoDiv.textContent = '';

            try {
                // Realizar el reconocimiento de texto con Tesseract.js
                // Se especifica el idioma espa√±ol ('spa') y un nivel de configuraci√≥n simple[citation:1]
                const { data: { text } } = await Tesseract.recognize(
                    canvas, // fuente de la imagen
                    'spa',  // c√≥digo de idioma para espa√±ol[citation:1]
                    {
                        logger: m => {
                            // Mostrar progreso detallado
                            if (m.status === 'recognizing text') {
                                statusDiv.textContent = `üìà Progreso: ${Math.round(m.progress * 100)}%`;
                            }
                        }
                    }
                );

                // Mostrar el resultado
                resultadoDiv.textContent = text || 'No se pudo detectar texto en la imagen.';
                statusDiv.textContent = '‚úÖ ¬°Texto extra√≠do con √©xito!';
                statusDiv.style.color = '#28a745';

            } catch (error) {
                // Manejo de errores
                statusDiv.textContent = '‚ùå Error en el proceso OCR.';
                statusDiv.style.color = '#dc3545';
                resultadoDiv.textContent = 'Error: ' + error.message;
                console.error('OCR Error:', error);
            }
        });

        // 5. Parar la c√°mara
        btnParar.addEventListener('click', () => {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                stream = null;
                btnActivar.disabled = false;
                btnCapturar.disabled = true;
                btnParar.disabled = true;
                btnCambiarCamara.disabled = true;
                resultadoDiv.textContent = 'C√°mara detenida.';
                statusDiv.textContent = '';
            }
        });
    </script>
</body>
</html>